<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ===== Meta & Title ===== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Opportunity Details</title>
  <script src="./assets/js/auth-guard.js"></script>

  <!-- ===== Fonts ===== -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- ===== Styles ===== -->
  <link rel="stylesheet" href="./assets/css/opportunity-detail.css" />
  <link rel="stylesheet" href="./assets/css/rich-comments.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- ===== Web Components / UI libs (modules load fast, safe to keep in head) ===== -->
  <!-- Keep ONE emoji-picker include (the duplicate was removed) -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
</head>

<body>
  <!-- ===== Fixed back button (with fallback) ===== -->
  <div id="fixedBackContainer">
    <button id="goBackButton" class="go-back-button" data-fallback="/opportunities.html">
      <span class="arrow">â†</span>
      <span class="text">Go Back</span>
    </button>
  </div>

  <!-- ===== Header / Tabs ===== -->
  <header class="detail-header">
    <div class="header-left">
      <h1 class="detail-title">Opportunity Detail</h1>
    </div>
    <nav class="detail-nav" aria-label="Opportunity sections">
      <ul>
        <li class="nav-item active">Overview</li>
        <li class="nav-item">Information</li>
        <li class="nav-item">Job Description</li>
        <li class="nav-item">Pipeline</li>
        <li class="nav-item">Candidates</li>
        <div class="nav-indicator"></div>
      </ul>
    </nav>
  </header>

  <!-- ===== Main Content ===== -->
  <main class="detail-main">
    <!-- ========== Overview ========== -->
    <section id="overview" class="detail-section">
      <div class="section-header">
        <div class="section-title">
          <h2 class="overview-title">Overview</h2>
          <p class="section-subtext"></p>
        </div>
        <button id="delete-opportunity-btn" class="danger-action hidden" type="button">Delete Opportunity</button>
      </div>

      <!-- Summary card: stage, IDs, dates, signed, hire, comments -->
      <div class="overview-card pastel-card" style="padding-top: 2rem;">
        <div class="stage-top">
          <div class="opportunity-id-card">
            <span class="label">Opportunity ID</span>
            <span id="opportunity-id-text" data-id=""></span>
          </div>
          <div class="opportunity-stage-card" id="stage-tag">
            <span id="stage-text">â€”</span>
          </div>
        </div>

        <div class="overview-grid">
          <div class="input-group">
            <label>Start Date</label>
            <input type="text" id="start-date-input" value="" />
          </div>

          <div class="input-group">
            <label>Signed</label>
            <div class="info-tag" id="signed-tag">â€”</div>
          </div>

          <div class="input-group">
            <label>Closed Date</label>
            <input type="text" id="close-date-input" placeholder="Closed Date" />
          </div>

          <div class="input-group">
            <label>Hire</label>
            <input id="hire-display" type="text" readonly placeholder="No hire assigned yet" />
          </div>
        </div>

        <div class="input-group comments-group">
          <label>Comments</label>
          <textarea id="comments-overview-textarea" placeholder="Write internal comments here..."></textarea>
        </div>
      </div>

      <!-- Client card -->
      <div class="overview-card">
        <div class="card-title-row">
          <button class="card-toggle" aria-expanded="true">
            <h3>Client</h3>
            <span class="toggle-icon">â–¾</span>
          </button>
        </div>
        <div class="card-content">
          <div class="overview-grid">
            <div class="input-group"><label>Name</label><input id="client-name-input" value="" readonly/></div>
            <div class="input-group"><label>Size</label><input type="text" id="client-size-input" value="" readonly /></div>
            <div class="input-group"><label>State</label><input id="client-state-input" value=""></div>
            <div class="input-group"><label>Linkedin</label><input id="client-linkedin-input" value=""></div>
            <div class="input-group"><label>Website</label><input id="client-website-input" value=""></div>
            <div class="input-group full"><label>Mail</label><input id="client-mail-input" value=""></div>
            <div class="input-group full">
              <label>About</label>
              <textarea id="client-about-textarea" placeholder="Client background, culture, values..." class="taller-textarea"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Details card -->
      <div class="overview-card">
        <button class="card-toggle" aria-expanded="true">
          <h3>Details</h3>
          <span class="toggle-icon">â–¾</span>
        </button>
        <div class="card-content">
          <div class="overview-grid">
            <div class="input-group"><label>Opportunity Name</label><input id="details-opportunity-name" value=""></div>
            <div class="input-group"><label>Account</label><input id="details-account-name" value="" readonly/></div>
            <div class="input-group"><label>Sales Lead</label><select id="details-sales-lead"><option></option></select></div>
            <div class="input-group"><label>HR Lead</label><select id="details-hr-lead"><option></option></select></div>
            <div class="input-group">
              <label>Model</label>
              <select id="details-model">
                <option value="staffing">Staffing</option>
                <option value="recruiting">Recruiting</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== Information ========== -->
    <section id="information" class="detail-section hidden">
      <div class="section-header"><p class="section-subtext"></p></div>

      <div class="overview-card">
        <div class="overview-grid">
          <!-- Budget & Salary -->
          <div class="input-group"><label>Client Budget</label><input id="min-budget-input" /></div>
          <div class="input-group"><label>&nbsp;</label><input id="max-budget-input" /></div>
          <div class="input-group"><label>Candidate Salary Range</label><input id="min-salary-input" /></div>
          <div class="input-group"><label>&nbsp;</label><input id="max-salary-input" /></div>

          <!-- Model (duplicate source of truth used by Fees visibility script) -->
          <div class="input-group">
            <label>Model</label>
            <select id="model-select">
              <option value="Staffing">Staffing</option>
              <option value="Recruiting">Recruiting</option>
            </select>
          </div>

          <!-- Other info -->
          <div class="input-group"><label>Years of Experience</label><input id="years-experience-input" /></div>
          <div class="input-group"><label>Set Up Fee</label><input id="fee-input" /></div>

          <!-- Expecteds (toggled by model) -->
          <div class="input-group">
            <label>Expected Fee</label>
            <input id="expected-fee-input" type="number" step="0.01" min="0" placeholder="0.00" />
          </div>
          <div class="input-group">
            <label>Expected Revenue</label>
            <input id="expected-revenue-input" type="number" step="0.01" min="0" placeholder="0.00" />
          </div>

          <div class="input-group"><label>Time Zone</label><input id="timezone-input" /></div>
          <div class="input-group full"><label>First Meeting Recording</label><input id="recording-input" /></div>
          <div class="input-group full"><label>Deep Dive Recording</label><input id="deepdive-recording-input" placeholder="Deep dive recording..." /></div>

          <!-- Rich notes (interviewing process) -->
          <div class="input-group full">
            <label>First Meeting Comments</label>
            <textarea id="comments-firstmeeting-textarea" placeholder="Summary of the first meeting..." class="taller-textarea"></textarea>
          </div>

          <div class="input-group full">
            <label>Client Interviewing Process</label>
            <div class="toolbar small-toolbar" id="interviewing-toolbar">
              <button data-command="bold" onclick="toggleActiveButton('bold', this)"><b>B</b></button>
              <button data-command="italic" onclick="toggleActiveButton('italic', this)"><i>I</i></button>
              <button onclick="document.execCommand('insertUnorderedList', false, '')">â€¢ List</button>
            </div>
            <div id="interviewing-process-editor" contenteditable="true" class="job-description-editor" placeholder="Describe the client interview steps..."></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== Job Description ========== -->
    <section id="job" class="detail-section hidden">
      <div class="job-header">
        <div class="job-header-left">
          <h2>Job Description</h2>
          <p class="subtitle">Complete job description for this opportunity.</p>
        </div>

        <div class="job-header-right">
          <div id="header-actions">
            <!-- Row 1: Send + Publish -->
            <div class="top-actions">
              <button id="send-btn" class="header-btn">Send</button>
              <button id="publish-career-btn" class="header-btn">Publish to Career Site</button>
              <div id="career-traffic-light" class="career-traffic-light status-off" data-tooltip="This opportunity is not published in the career site." aria-label="This opportunity is not published in the career site.">
                <span class="light red"></span>
                <span class="light yellow"></span>
                <span class="light green"></span>
              </div>
            </div>
            <!-- Row 2: Pause + Delete -->
            <div class="bottom-actions" id="sheet-quick-actions">
              <button id="pause-career-btn" class="header-btn ghost-btn" title="Archive on Sheet"><span class="icon">â¸ï¸</span></button>
              <button id="delete-career-btn" class="header-btn danger-ghost-btn" title="Delete on Sheet"><span class="icon">ğŸ—‘ï¸</span></button>
            </div>
          </div>
        </div>
      </div>

      <!-- Job editor toolbar -->
      <div class="toolbar" id="job-toolbar">
        <button data-command="bold" onclick="toggleActiveButton('bold', this)"><b>B</b></button>
        <button data-command="italic" onclick="toggleActiveButton('italic', this)"><i>I</i></button>
        <button onclick="document.execCommand('insertUnorderedList', false, '')">â€¢ List</button>

        <!-- Emoji picker trigger -->
        <div style="position: relative; display: inline-block;">
          <button id="emoji-trigger">ğŸ˜Š</button>
          <emoji-picker id="emoji-picker" style="position: absolute; top: 100%; left: 0; display: none;"></emoji-picker>
        </div>
      </div>

      <div class="job-card">
        <div id="job-description-textarea" contenteditable="true" class="job-description-editor" placeholder="Write your message here..."></div>
      </div>
    </section>

    <!-- ========== Pipeline ========== -->
    <section id="pipeline" class="detail-section hidden pipeline-section">
      <div class="pipeline-header">
        <h2>Pipeline</h2>
        <div class="pipeline-actions">
          <!-- ğŸ”¢ Small counter for interviewed candidates -->
          <div class="interview-count">
            <label for="interviewed-count-input">Number of interviewed candidates</label>
            <input
              id="interviewed-count-input"
              type="number"
              min="0"
              step="1"
              inputmode="numeric"
              placeholder="0"
            />
            <span id="interviewed-count-status" class="interview-count-status"></span>
          </div>

          <button id="pipelineAddCandidateBtn">+ Add Candidate</button>
          <button id="signOffBtn">Sign off</button>
        </div>
      </div>

      <div class="pipeline-columns">
        <!-- Column: Applicant -->
        <div class="column" data-status="applicant">
          <h3 class="column-title" style="background-color:#fff7ed;">
            <span class="column-name">Applicant</span>
            <span class="column-count" id="count-applicant">0</span>
          </h3>
          <div class="card-container" id="applicant"></div>
        </div>

        <!-- Column: Contacted -->
        <div class="column" data-status="contacted">
          <h3 class="column-title" style="background-color:#fef2f2;">
            <span class="column-name">Contactado</span>
            <span class="column-count" id="count-contacted">0</span>
          </h3>
          <div class="card-container" id="contacted"></div>
        </div>

        <!-- Column: First interview -->
        <div class="column" data-status="first-interview">
          <h3 class="column-title" style="background-color:#edf4ff;">
            <span class="column-name">Primera entrevista</span>
            <span class="column-count" id="count-first-interview">0</span>
          </h3>
          <div class="card-container" id="first-interview"></div>
        </div>

        <!-- Column: No avanza -->
        <div class="column" data-status="no-advance">
          <h3 class="column-title" style="background-color:#effaf0;">
            <span class="column-name">No avanza</span>
            <span class="column-count" id="count-no-advance">0</span>
          </h3>
          <div class="card-container" id="no-advance"></div>
        </div>

        <!-- Column: Client process -->
        <div class="column" data-status="client-process">
          <h3 class="column-title" style="background-color:#fef3fb;">
            <span class="column-name">En proceso con Cliente</span>
            <span class="column-count" id="count-client-process">0</span>
          </h3>
          <div class="card-container" id="client-process"></div>
        </div>
      </div>

      <div
        id="pipelineRestrictionToast"
        class="pipeline-restriction-toast"
        role="alert"
        aria-live="assertive"
      >
        <span class="pipeline-restriction-toast__emoji" aria-hidden="true">ğŸš¦</span>
        <span class="pipeline-restriction-toast__text">
          Oops! You can only move candidates forward in this pipeline.
        </span>
      </div>
    </section>

    <!-- ========== Candidates / Batches ========== -->
    <section id="candidates" class="detail-section fade-in">
      <div class="candidates-header">
        <div>
          <h2>Candidates</h2>
          <p class="subtitle">See the final candidates for this opportunity.</p>
        </div>
      </div>

      <!-- Batches table -->
      <div class="batch-table">
        <table>
          <thead>
            <tr>
              <th>Batch #</th>
              <th>Presentation Date</th>
              <th>Time (days)</th>
            </tr>
          </thead>
          <tbody id="presentation-batch-table-body"><!-- rows injected dynamically --></tbody>
        </table>
      </div>

      <!-- Batch detail cards -->
      <div class="batch-detail" id="batch-detail-container"><!-- batch boxes injected dynamically --></div>

      <div class="create-batch-wrap">
        <button class="btn-create">Create new batch</button>
      </div>
    </section>
  </main>

  <!-- ===== AI Assistant (hidden by default) ===== -->
  <div id="ai-assistant-btn" style="display: none;">âœ¨ AI Assistant âœ¨</div>
  <div id="ai-assistant-popup" class="ai-popup hidden">
    <div class="ai-popup-content">
      <span id="ai-assistant-close" class="ai-close-x">Ã—</span>
      <h2>AI Assistant</h2>

      <label>Intro Call</label>
      <textarea placeholder="00:00 Speaker: Text here..."></textarea>

      <label>Deep Dive Call</label>
      <input type="text" placeholder="2nd_Call_Transcript" />

      <label>Notes / Emails</label>
      <textarea placeholder="Your notes here..."></textarea>

      <label>Files</label>
      <div class="file-upload" onclick="document.getElementById('ai-file-input').click()">
        <input type="file" id="ai-file-input" />
        <div class="upload-icon">ğŸ“</div>
      </div>

      <div class="button-group">
        <button id="ai-assistant-go">Let's Go ğŸš€</button>
      </div>
    </div>
  </div>

  <!-- ===== Popups: Candidate / Batch / Email flows ===== -->
  <div id="candidatePopup" class="popup hidden">
    <div class="popup-content">
      <span class="close-btn" id="closePopup">&times;</span>
      <h2>Add Candidate</h2>

      <!-- Search + warning -->
      <input type="text" id="candidate-name" placeholder="Full name *" autocomplete="off"/>
      <p id="name-warning" style="display: none;">Please select a candidate from the list</p>
      <ul id="pipelineCandidateSearchResults" class="search-results-list"></ul>

      <!-- Fields for new candidate -->
      <div id="extra-fields">
        <input type="text" id="candidate-email" placeholder="Email *" />

        <!-- Country -->
        <select id="candidate-country" required>
          <option value="">Select country...</option>
          <option value="Argentina">ğŸ‡¦ğŸ‡· Argentina</option>
          <option value="Bolivia">ğŸ‡§ğŸ‡´ Bolivia</option>
          <option value="Brazil">ğŸ‡§ğŸ‡· Brazil</option>
          <option value="Chile">ğŸ‡¨ğŸ‡± Chile</option>
          <option value="Colombia">ğŸ‡¨ğŸ‡´ Colombia</option>
          <option value="Costa Rica">ğŸ‡¨ğŸ‡· Costa Rica</option>
          <option value="Cuba">ğŸ‡¨ğŸ‡º Cuba</option>
          <option value="Ecuador">ğŸ‡ªğŸ‡¨ Ecuador</option>
          <option value="El Salvador">ğŸ‡¸ğŸ‡» El Salvador</option>
          <option value="Guatemala">ğŸ‡¬ğŸ‡¹ Guatemala</option>
          <option value="Honduras">ğŸ‡­ğŸ‡³ Honduras</option>
          <option value="Mexico">ğŸ‡²ğŸ‡½ Mexico</option>
          <option value="United States">ğŸ‡ºğŸ‡¸ United States</option>
          <option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option>
          <option value="Nicaragua">ğŸ‡³ğŸ‡® Nicaragua</option>
          <option value="Panama">ğŸ‡µğŸ‡¦ Panama</option>
          <option value="Paraguay">ğŸ‡µğŸ‡¾ Paraguay</option>
          <option value="Peru">ğŸ‡µğŸ‡ª Peru</option>
          <option value="Puerto Rico">ğŸ‡µğŸ‡· Puerto Rico</option>
          <option value="Dominican Republic">ğŸ‡©ğŸ‡´ Dominican Republic</option>
          <option value="Uruguay">ğŸ‡ºğŸ‡¾ Uruguay</option>
          <option value="Venezuela">ğŸ‡»ğŸ‡ª Venezuela</option>
        </select>

        <!-- Phone (kept simple; intl-tel-input available if you init it elsewhere) -->
        <div style="display: flex; gap: 8px;">
          <select id="phone-country-code" style="width: 30%;">
            <option value="54" selected>ğŸ‡¦ğŸ‡· +54    Argentina</option>
            <option value="591">ğŸ‡§ğŸ‡´ +591   Bolivia</option>
            <option value="55">ğŸ‡§ğŸ‡· +55    Brasil</option>
            <option value="56">ğŸ‡¨ğŸ‡± +56    Chile</option>
            <option value="57">ğŸ‡¨ğŸ‡´ +57    Colombia</option>
            <option value="506">ğŸ‡¨ğŸ‡· +506  Costa Rica</option>
            <option value="53">ğŸ‡¨ğŸ‡º +53    Cuba</option>
            <option value="593">ğŸ‡ªğŸ‡¨ +593  Ecuador</option>
            <option value="503">ğŸ‡¸ğŸ‡» +503  El Salvador</option>
          <option value="502">ğŸ‡¬ğŸ‡¹ +502  Guatemala</option>
          <option value="504">ğŸ‡­ğŸ‡³ +504  Honduras</option>
          <option value="52">ğŸ‡²ğŸ‡½ +52    MÃ©xico</option>
          <option value="1">ğŸ‡ºğŸ‡¸ +1     United States</option>
          <option value="1">ğŸ‡¨ğŸ‡¦ +1     Canada</option>
          <option value="505">ğŸ‡³ğŸ‡® +505  Nicaragua</option>
          <option value="507">ğŸ‡µğŸ‡¦ +507  PanamÃ¡</option>
          <option value="595">ğŸ‡µğŸ‡¾ +595  Paraguay</option>
          <option value="51">ğŸ‡µğŸ‡ª +51    PerÃº</option>
          <option value="1">ğŸ‡µğŸ‡· +1     Puerto Rico</option>
          <option value="1">ğŸ‡©ğŸ‡´ +1     RepÃºblica Dominicana</option>
          <option value="598">ğŸ‡ºğŸ‡¾ +598  Uruguay</option>
          <option value="58">ğŸ‡»ğŸ‡ª +58    Venezuela</option>
          </select>
        <div id="candidate-us-state-wrapper" class="hidden">
          <label for="candidate-us-state">State (USA)</label>
          <select id="candidate-us-state">
            <option value="">Select stateâ€¦</option>
          </select>
        </div>
          <input type="text" id="candidate-phone" placeholder="Phone number *" style="width: 70%;" />
        </div>

        <input type="text" id="candidate-linkedin" placeholder="LinkedIn URL *" />
        <button id="popupcreateCandidateBtn">Create Candidate</button>
      </div>

      <button id="popupAddExistingBtn" style="display:none;">Add Candidate to Pipeline</button>
    </div>
  </div>

  <div id="pipelineSearchPopup" class="popup hidden">
    <div class="popup-content">
      <span class="close-btn" id="closePipelineSearchPopup">&times;</span>
      <h2>Add Candidate to Pipeline</h2>
      <input
        type="text"
        id="pipeline-search-input"
        placeholder="Search by name or LinkedInâ€¦"
        autocomplete="off"
      />
      <p id="pipeline-search-start" class="search-hint" style="font-size:0.9rem; color:#555;">Type at least 2 characters to search existing candidates.</p>
      <p id="pipeline-search-loading" class="search-hint" style="display:none; font-size:0.9rem; color:#555;">Searchingâ€¦</p>
      <p id="pipeline-search-empty" class="search-hint" style="display:none; font-size:0.9rem; color:#555;">No matches found.</p>
      <p id="pipeline-search-error" class="search-hint" style="display:none; color:#b3261e; font-weight:500;"></p>
      <p id="pipeline-search-success" class="search-hint" style="display:none; color:#007a5a; font-weight:500;"></p>
      <ul id="pipeline-search-results" class="search-results-list"></ul>
    </div>
  </div>

  <!-- Popup: candidate associations -->
  <div id="candidateAssociationPopup" class="popup hidden">
    <div class="popup-content association-popup-content">
      <span class="close-btn" id="closeCandidateAssociationPopup">&times;</span>
      <h2 id="candidateAssociationTitle">Candidate associations</h2>
      <p id="candidateAssociationMessage" class="association-message"></p>
      <div id="candidateAssociationList" class="association-list"></div>
      <div id="candidateAssociationActions" class="association-actions hidden">
        <button type="button" id="candidateAssociationCancelBtn" class="btn-ghost">Cancel</button>
        <button type="button" id="candidateAssociationConfirmBtn" class="btn-primary">Yes, add candidate</button>
      </div>
    </div>
  </div>

  <!-- Popup: add candidate to batch -->
  <div id="batchCandidatePopup" class="popup hidden">
    <div class="popup-content">
      <span class="close-btn" id="closeBatchPopup">&times;</span>
      <h2>Select Candidate</h2>
      <input type="text" id="candidateSearchInput" placeholder="Search by name..." />
      <ul id="candidateSearchResults" class="search-results-list"></ul>
    </div>
  </div>

  <!-- Template: pipeline candidate card -->
  <template id="candidate-card-template">
    <div class="candidate-card">
      <div class="candidate-card-header">
        <div class="candidate-info-inline">
          <strong class="candidate-name">Name</strong>
          <span class="candidate-country">ğŸ‡²ğŸ‡½ Mexico</span>
          <span class="candidate-salary">$3500</span>
        </div>

        <select class="candidate-status-dropdown pipeline-only-hide">
          <option disabled value="">Select status...</option>
          <option value="Client rejected CV">Client rejected CV</option>
          <option value="Client interviewing/testing">Client interviewing/testing</option>
          <option value="Client rejected after interviewing">Client rejected after interviewing</option>
          <option value="Candidate abandoned process">Candidate abandoned process</option>
          <option value="Client hired">Client hired</option>
        </select>
      </div>

      <div class="preview">
        <img class="candidate-img" src="" />
        <div class="info">
          <span class="name candidate-name">Name</span>
          <span class="email candidate-email"></span>
          <span class="salary candidate-salary"></span>
          <span class="country candidate-country"></span>
        </div>
      </div>
    </div>
  </template>

  <!-- Email popups -->
  <div id="emailPopup" class="popup hidden">
    <div class="popup-content email-popup-content">
      <span class="close-btn" id="closeEmailPopup">&times;</span>
      <h2>Send Job Description</h2>

      <label>To</label>
      <select id="email-to" multiple></select>

      <label>CC</label>
      <select id="email-cc" multiple></select>

      <label>Subject</label>
      <input type="text" id="email-subject" placeholder="Subject..." />

      <label>Message</label>
      <div id="email-message" class="rich-editor" contenteditable="true" style="height: 200px; border: 1px solid #ccc; padding: 10px; border-radius: 8px;"></div>

      <button id="sendEmailBtn">Send</button>
    </div>
  </div>

  <!-- Email overlay spinner -->
  <div id="email-overlay" class="email-overlay hidden">
    <div class="email-overlay-content">
      <span class="spinner"></span>
      <p id="email-overlay-message">Sending email...</p>
    </div>
  </div>

  <!-- Sign Off -->
  <div id="signOffPopup" class="popup hidden">
    <div class="popup-content email-popup-content">
      <span class="close-btn" id="closeSignOffPopup">&times;</span>
      <h2>Send Rejection Email</h2>

      <label>To</label>
      <select id="signoff-to" multiple></select>

      <label>Subject</label>
      <input type="text" id="signoff-subject" value="Update on your application" />

      <label>Message</label>
      <textarea id="signoff-message" style="height: 200px;">Dear applicant,

Thank you so much for being part of our process at Vintti. After careful consideration, weâ€™ve decided to move forward with another candidate.

We truly appreciate your time and interest!
If you'd like to share your experience with the selection process, hereâ€™s a short anonymous survey (under 3 minutes):
ğŸ”— https://tally.so/r/w7K859

Wishing you all the best in your journey! âœ¨
Warmly,
the Vintti team</textarea>

      <div style="margin-top: 10px;">
        <button id="toggleLangBtn">Change Language</button>
      </div>

      <button id="sendSignOffBtn">Send</button>
    </div>
  </div>

  <!-- Approval email -->
  <div id="approvalEmailPopup" class="popup hidden">
    <div class="popup-content email-popup-content">
      <span class="close-btn" id="closeApprovalEmailPopup">&times;</span>
      <h2>Send Candidates for Approval</h2>

      <label>To</label>
      <select id="approval-to" multiple></select>

      <label>CC</label>
      <select id="approval-cc" multiple></select>

      <label>Subject</label>
      <input type="text" id="approval-subject" placeholder="Subject..." />

      <label>Message</label>
      <div id="approval-message" contenteditable="true" style="height: 300px; border: 1px solid #ccc; padding: 10px; border-radius: 8px; overflow-y: auto;"></div>

      <button id="sendApprovalEmailBtn">Send</button>
    </div>
  </div>

  <!-- Create batch -->
  <div id="createBatchPopup" class="popup hidden">
    <div class="popup-content">
      <span class="close-btn" id="closeCreateBatchPopup">&times;</span>
      <h2>Create New Batch</h2>
      <label for="presentationDateInput">Presentation Date</label>
      <input type="date" id="presentationDateInput" />
      <button id="confirmCreateBatchBtn">Create Batch</button>
    </div>
  </div>

  <!-- Publish to career site -->
  <div id="publishCareerPopup" class="popup hidden">
    <div class="popup-content" style="max-width:820px;">
      <span class="close-btn" id="closePublishCareerPopup">&times;</span>
      <h2>Publish to Career Site</h2>

      <div class="career-actions">
        <button id="career-ai-btn" class="btn-ghost" title="Generate sections from Job Description">â­ Generate</button>
        <span id="career-ai-status" class="ai-status" style="display:none;margin-left:8px;font-weight:600;">â³ Generatingâ€¦</span>
      </div>

      <div class="overview-grid">
        <div class="input-group">
          <label>Job ID</label>
          <input id="career-jobid" type="text" readonly />
        </div>

        <div class="input-group">
          <label>Job</label>
          <input id="career-job" type="text" placeholder="Job title..." />
        </div>

        <div class="input-group">
          <label>Country</label>
          <select id="career-country" multiple></select>
        </div>

        <div class="input-group">
          <label>City</label>
          <select id="career-city" disabled></select>
        </div>

        <div class="input-group">
          <label>Job Type</label>
          <select id="career-jobtype">
            <option value="" selected disabled>Selectâ€¦</option>
            <option value="full-time">Full time</option>
            <option value="part-time">Part time</option>
          </select>
        </div>

        <div class="input-group">
          <label>Seniority</label>
          <select id="career-seniority">
            <option value="" selected disabled>Selectâ€¦</option>
            <option value="entry-level">Entry-level</option>
            <option value="junior">Junior</option>
            <option value="semi-senior">Semi-senior</option>
            <option value="senior">Senior</option>
            <option value="manager">Manager</option>
          </select>
        </div>

        <div class="input-group">
          <label>Experience Level</label>
          <select id="career-exp-level">
            <option value="" selected disabled>Selectâ€¦</option>
            <option value="entry level job">Entry level job</option>
            <option value="experienced">Experienced</option>
          </select>
        </div>

        <div class="input-group">
          <label>Field</label>
          <select id="career-field">
            <option value="" selected disabled>Selectâ€¦</option>
            <option value="accounting">Finance & Accounting</option>
            <option value="it">Sales & Business Development</option>
            <option value="legal">Customer Support</option>
            <option value="marketing">Marketing</option>
            <option value="virtual assistant">Legal</option>
            <option value="it">Human Resources</option>
            <option value="legal">Virtual & Executive Assistant</option>
            <option value="marketing">Design & Project Management</option>
            <option value="virtual assistant">IT, Engineering & Software Development</option>
          </select>
        </div>

        <div class="input-group">
          <label>Work modality</label>
          <select id="career-modality">
            <option value="" selected disabled>Selectâ€¦</option>
            <option value="remote">Remote</option>
            <option value="hybrid">Hybrid</option>
            <option value="on site">On site</option>
          </select>
        </div>

        <div class="input-group">
          <label>Years of Experience</label>
          <input id="career-years" type="number" min="0" placeholder="e.g. 3" />
        </div>

        <div class="input-group full field-desc">
          <label>Description</label>
          <textarea id="career-description" class="taller-textarea" placeholder="Job description..."></textarea>
        </div>

        <div class="input-group full field-req">
          <label>Requirements</label>
          <textarea id="career-requirements" class="taller-textarea" placeholder="Requirements..."></textarea>
        </div>

        <div class="input-group full field-add">
          <label>Additional Information</label>
          <textarea id="career-additional" class="taller-textarea" placeholder="Additional information..."></textarea>
        </div>

        <div class="actions-row">
          <button id="saveDraftCareerBtn">Save Draft</button>
          <button id="publishCareerBtn" class="header-btn">Publish</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Delete Opportunity Modal ===== -->
  <div id="deleteOpportunityModal" class="opportunity-delete-modal hidden" role="dialog" aria-modal="true" aria-labelledby="deleteOppTitle" aria-describedby="deleteOppDesc">
    <div class="opportunity-delete-card" role="document">
      <div class="opportunity-delete-icon" aria-hidden="true">!</div>
      <h3 id="deleteOppTitle">Delete this opportunity?</h3>
      <p id="deleteOppDesc">Are you sure you want to delete this opportunity? This action cannot be reversed.</p>
      <div class="opportunity-delete-actions">
        <button type="button" class="delete-cancel-btn">Cancel</button>
        <button type="button" class="delete-confirm-btn">Yes, delete</button>
      </div>
    </div>
  </div>

  <!-- ===== Scripts (deferred to avoid blocking) ===== -->
  <!-- Choices.js (multiselects) -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js" defer></script>

  <!-- Phone input lib (kept; only remove if confirmed unused across your JS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js" defer></script>

  <!-- Your app bundles -->
  <script src="./assets/js/rich-comment-box.js" defer></script>
  <script src="./assets/js/pipeline.js" defer></script>
  <script src="./assets/js/opportunity-detail.js" defer></script>

  <!-- ===== Fees visibility helper (kept names & behavior) ===== -->
  <script>
    // === FEES: show only for Staffing, hide for Recruiting ===
    // Helper: find the .input-group parent of an input/select by ID
    function __fee_findGroup(inputId){
      const el = document.getElementById(inputId);
      return el ? el.closest('.input-group') : null;
    }

    // Helper: toggle visibility + disable input when hidden (no data loss on show)
    function __fee_setVisible(inputId, visible){
      const group = __fee_findGroup(inputId);
      if (!group) return;
      group.classList.toggle('hide-fee-group', !visible);
      const input = group.querySelector('input, select, textarea');
      if (input) input.disabled = !visible;
    }

    // Reads current model from either select (case-insensitive)
    function __fee_getModel(){
      const a = document.getElementById('details-model')?.value || '';
      const b = document.getElementById('model-select')?.value || '';
      return (a || b).toString().trim().toLowerCase();
    }

    // Apply visibility rules based on model
    function __fee_apply(){
      const isStaffing = __fee_getModel().includes('staff'); // tolerant to â€œStaffingâ€
      __fee_setVisible('fee-input',          isStaffing); // Set Up Fee
      __fee_setVisible('expected-fee-input', isStaffing); // Expected Fee
    }

    // Wire change listeners safely (idempotent)
    function __fee_wire(){
      ['details-model','model-select'].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        if (el.__fee_wired) return;           // avoid duplicates
        el.addEventListener('change', __fee_apply, { passive:true });
        el.__fee_wired = true;
      });
      __fee_apply();
    }

    // Init on DOM ready + delayed re-apply in case values are set after fetch
    document.addEventListener('DOMContentLoaded', () => {
      __fee_wire();
      setTimeout(__fee_apply, 100);
      setTimeout(__fee_apply, 500);
    });

    // If you change the model programmatically elsewhere, call: __fee_apply();
  </script>
</body>
</html>
