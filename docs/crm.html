<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ===== Meta ===== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM</title>
  <script src="./assets/js/auth-guard.js"></script>
  <script src="./assets/js/monthly-mood.js?v=2" defer></script>
  <meta name="theme-color" content="#0B3D91">

  <!-- ===== Favicons / PWA ===== -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/icons/vintti-hub-180.png">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#0B3D91">

  <!-- ===== Fonts (Onest) ===== -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;600&display=swap" rel="stylesheet">

  <!-- ===== Vendor CSS (DataTables) ===== -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

  <!-- ===== App CSS (scoped) ===== -->
  <link rel="stylesheet" href="./assets/css/crm.css" />
  <link rel="stylesheet" href="./assets/css/monthly-mood.css?v=2" />
  <link rel="stylesheet" href="./assets/css/sidebar.css" />
  <style>
    .filters-top-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }
    .filters-top-bar > * { flex-shrink: 0; }
    .dataTables-length-wrapper {
      margin-left: auto;
      display: flex;
      align-items: center;
      height: 100%;
    }
    .multi-filter {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 160px;
    }
    .filter-header {
      font-weight: 600;
      font-size: 13px;
      color: #2a2a2a;
    }
    .multi-select {
      position: relative;
      display: flex;
    }
    .multi-filter select {
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      padding: 10px 40px 10px 18px;
      font-size: 13px;
      font-family: 'Onest', sans-serif;
      width: 100%;
      background: #fff;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08), 0 4px 12px rgba(15, 23, 42, 0.08);
      -webkit-appearance: none;
      appearance: none;
      background-clip: padding-box;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .multi-filter select:focus {
      outline: none;
      border-color: #cddcfe;
      box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.12);
    }
    .multi-filter select::-ms-expand { display: none; }
    .multi-select::after {
      content: '';
      pointer-events: none;
      position: absolute;
      right: 18px;
      top: 50%;
      width: 12px;
      height: 6px;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='6' viewBox='0 0 12 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 4 5-4' stroke='%23001133' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-size: 100% 100%;
      transform: translateY(-50%);
      opacity: .65;
    }
    .text-filter input {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      min-width: 220px;
      font-size: 14px;
      font-family: 'Onest', sans-serif;
      background: linear-gradient(135deg, #ffffff, #f2f4f7);
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08), 0 6px 16px rgba(15, 23, 42, 0.08);
    }
    .crm-loading-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(11,61,145,0.15), rgba(255,255,255,0.95));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity .3s ease, visibility .3s ease;
    }
    .crm-loading-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .crm-loading-card {
      background: #fff;
      border-radius: 20px;
      padding: 28px 32px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.25);
      text-align: center;
      width: min(420px, 90%);
      position: relative;
      overflow: hidden;
    }
    .crm-loading-card::after {
      content: '';
      position: absolute;
      inset: 4px;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(11,61,145,0.08), rgba(205,255,48,0.2));
      z-index: -1;
    }
    .crm-loading-spinner {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 6px solid rgba(11,61,145,0.15);
      border-top-color: #0b3d91;
      margin: 0 auto 16px;
      animation: crm-spin 0.8s linear infinite;
    }
    @keyframes crm-spin {
      to { transform: rotate(360deg); }
    }
    .crm-loading-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #0b3d91;
      margin-bottom: 6px;
    }
    .crm-loading-text {
      font-size: 0.95rem;
      color: #1f2937;
    }
    .crm-loading-progress {
      width: 100%;
      height: 10px;
      background: rgba(11, 61, 145, 0.12);
      border-radius: 999px;
      margin: 16px 0 8px;
      overflow: hidden;
    }
    .crm-loading-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #0b3d91, #cdff30);
      transition: width 0.2s ease;
    }
    .crm-loading-percent {
      font-size: 0.85rem;
      color: #1f2937;
      margin: 0;
    }
  </style>
</head>

<body>
  <div id="crmLoadingOverlay" class="crm-loading-overlay hidden" aria-live="polite" aria-label="Loading CRM accounts" aria-hidden="true">
    <div class="crm-loading-card">
      <div class="crm-loading-spinner" aria-hidden="true"></div>
      <p class="crm-loading-title">Loading CRM</p>
      <p class="crm-loading-text">Fetching accounts and calculating statusesâ€¦</p>
      <div class="crm-loading-progress" id="crmLoadingProgress" aria-hidden="true">
        <div class="crm-loading-bar" id="crmLoadingBar" style="width:0%"></div>
      </div>
      <p class="crm-loading-percent" id="crmLoadingPercent" aria-live="polite"></p>
    </div>
  </div>
  <!-- ====================== SIDEBAR ====================== -->
  <div id="sidebarMount"></div>

  <!-- Sidebar wow toggle (kept ids/classes) -->
  <!-- <div class="sidebar-wow-toggle" id="sidebarToggle" role="button" aria-label="Toggle sidebar" tabindex="0">
    <i class="fa-solid fa-chevron-left" id="sidebarToggleIcon" aria-hidden="true"></i>
  </div> -->

  <!-- ====================== MAIN ====================== -->
  <div class="main-content">
    <!-- Top bar: title + primary action -->
    <header class="page-header">
      <h1 class="page-title">CRM</h1>
      <div class="page-actions">
        <button class="refresh-btn" id="crmRefreshBtn" type="button">
          Refresh
        </button>
        <button class="new-btn" onclick="openPopup()">New</button>
      </div>
    </header>

    <section class="filters-top-bar" aria-label="Table filters">
      <div class="dataTables-length-wrapper" id="dataTablesLengthTarget" aria-live="polite"></div>

      <div class="multi-filter" id="salesLeadFilterContainer">
        <div class="filter-header">
          <label for="salesLeadFilter">Sales Lead</label>
        </div>
        <div class="multi-select">
          <select id="salesLeadFilter" data-filter-key="salesLead" aria-label="Filter by Sales Lead">
            <option value="">All Sales Leads</option>
          </select>
        </div>
      </div>

      <div class="multi-filter" id="statusFilterContainer">
        <div class="filter-header">
          <label for="statusFilter">Status</label>
        </div>
        <div class="multi-select">
          <select id="statusFilter" data-filter-key="status" aria-label="Filter by Status">
            <option value="">All Statuses</option>
          </select>
        </div>
      </div>

      <div class="multi-filter" id="contractFilterContainer">
        <div class="filter-header">
          <label for="contractFilter">Contract</label>
        </div>
        <div class="multi-select">
          <select id="contractFilter" data-filter-key="contract" aria-label="Filter by Contract">
            <option value="">All Contracts</option>
          </select>
        </div>
      </div>

      <div class="text-filter">
        <input
          type="text"
          id="searchClientInput"
          placeholder="Search by Client Name"
          inputmode="search"
          aria-label="Search by Client Name"
        />
      </div>
    </section>

    <!-- Accounts table (DataTables enhances this) -->
    <table id="accountTable">
      <thead>
        <tr>
          <th>Client Name</th>
          <th>Status</th>
          <th>Sales Lead</th>
          <th>Contract</th>
          <th>TRR</th>
          <th>TSF</th>
          <th>TSR</th>
        </tr>
      </thead>
      <tbody id="accountTableBody"><!-- rows rendered by JS --></tbody>
    </table>
    <p id="crmEmptyState" class="crm-empty-state" role="status" aria-live="polite">
      No results match these filters.
    </p>
  </div>

  <!-- ====================== POPUP (Create Account) ====================== -->
  <div id="popup" class="popup-overlay" aria-hidden="true">
    <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
      <span class="close-btn" onclick="closePopup()" aria-label="Close">&times;</span>
      <h2 class="popup-title" id="popupTitle">New Account</h2>
        <form class="popup-form two-columns">
          <!-- Company Name -->
          <div class="popup-field">
            <label>Company Name</label>
            <input type="text" name="name" placeholder="Account name" />
          </div>
          <!-- Contact Name + Surname en una sola fila -->
          <div class="popup-field full popup-inline">
            <div class="inline-group">
              <div class="field-half">
                <label>Name</label>
                <input type="text" name="contact_name" placeholder="Name" />
              </div>
              <div class="field-half">
                <label>Surname</label>
                <input type="text" name="contact_surname" placeholder="Surname" />
              </div>
            </div>
          </div>

          <!-- ðŸ†• Industry -->
          <div class="popup-field">
            <label>Industry</label>
            <input type="text" name="industry" placeholder="e.g. Fintech, SaaS, E-commerce" />
          </div>

          <!-- Size -->
          <div class="popup-field">
            <label>Size</label>
            <select name="size">
              <option value="1-10">1-10</option>
              <option value="11-50">11-50</option>
              <option value="51-200">51-200</option>
              <option value="201-500">201-500</option>
              <option value="+500">+500</option>
            </select>
          </div>

          <!-- Timezone -->
          <div class="popup-field">
            <label>Timezone</label>
            <select name="timezone">
              <option>EST</option>
              <option>CST</option>
              <option>PST</option>
              <option>MST</option>
              <option>AST</option>
              <option>HST</option>
            </select>
          </div>

          <!-- State -->
          <div class="popup-field">
            <label>State</label>
            <select name="state">
              <option>Alabama</option>
              <option>Alaska</option>
              <option>Arizona</option>
              <option>Arkansas</option>
              <option>California</option>
              <option>Colorado</option>
              <option>Connecticut</option>
              <option>Delaware</option>
              <option>Florida</option>
              <option>Georgia</option>
              <option>Hawaii</option>
              <option>Idaho</option>
              <option>Illinois</option>
              <option>Indiana</option>
              <option>Iowa</option>
              <option>Kansas</option>
              <option>Kentucky</option>
              <option>Louisiana</option>
              <option>Maine</option>
              <option>Maryland</option>
              <option>Massachusetts</option>
              <option>Michigan</option>
              <option>Minnesota</option>
              <option>Mississippi</option>
              <option>Missouri</option>
              <option>Montana</option>
              <option>Nebraska</option>
              <option>Nevada</option>
              <option>New Hampshire</option>
              <option>New Jersey</option>
              <option>New Mexico</option>
              <option>New York</option>
              <option>North Carolina</option>
              <option>North Dakota</option>
              <option>Ohio</option>
              <option>Oklahoma</option>
              <option>Oregon</option>
              <option>Pennsylvania</option>
              <option>Rhode Island</option>
              <option>South Carolina</option>
              <option>South Dakota</option>
              <option>Tennessee</option>
              <option>Texas</option>
              <option>Utah</option>
              <option>Vermont</option>
              <option>Virginia</option>
              <option>Washington</option>
              <option>West Virginia</option>
              <option>Wisconsin</option>
              <option>Wyoming</option>
              <option>Other</option>
            </select>
          </div>

          <!-- Website -->
          <div class="popup-field">
            <label>Website</label>
            <input type="text" name="website" placeholder="e.g. example.com" />
          </div>

          <!-- Email -->
          <div class="popup-field">
            <label>Email</label>
            <input type="email" name="mail" placeholder="e.g. hello@company.com" />
          </div>

          <!-- LinkedIn -->
          <div class="popup-field">
            <label>LinkedIn</label>
            <input type="text" name="linkedin" placeholder="LinkedIn URL" />
          </div>

          <!-- Lead source -->
          <div class="popup-field">
            <label>Lead source</label>
            <select name="where_come_from" required>
              <option value="" disabled selected>Select source</option>
              <option>SEO</option>
              <option>AI</option>
              <option>Slack Community</option>
              <option>Referral</option>
              <option>Re-target</option>
              <option>Outbound</option>
              <option>Linkedin - Agus</option>
            </select>
          </div>

          <!-- Referral source (shown only when Lead source = Referral) -->
          <div class="popup-field" id="referralSourceWrapper" style="display:none">
            <label>Referral â€“ Client</label>
            <div class="referral-source-mode" role="group" aria-label="Referral type">
              <label class="inline-radio">
                <input type="radio" name="referral_source_mode" value="existing" checked />
                Existing client
              </label>
              <label class="inline-radio">
                <input type="radio" name="referral_source_mode" value="other" />
                Other
              </label>
            </div>
            <div id="referralSearchContainer">
              <input
                type="text"
                name="referal_source"
                id="referralSourceInput"
                placeholder="Type to search clientsâ€¦"
                list="referralList"
                autocomplete="off"
              />
              <datalist id="referralList"></datalist>
              <small class="muted">Choose the client who referred this account.</small>
            </div>
            <div id="referralOtherContainer" style="display:none">
              <input
                type="text"
                id="referralOtherInput"
                name="referal_source_other"
                placeholder="Who referred this account?"
                autocomplete="off"
              />
              <small class="muted">Enter the referral source manually.</small>
            </div>
          </div>

          <!-- ðŸ†• Outsource before (boolean) -->
          <div class="popup-field">
            <label>Outsource before</label>
            <select name="outsource">
              <option value="">Selectâ€¦</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>

          <!-- ðŸ†• Pain point -->
          <div class="popup-field">
            <label>Pain point</label>
            <select name="pain_points">
              <option value="na">NA</option>
              <option value="high salary">High salary</option>
              <option value="no real pain point">No real pain point</option>
              <option value="cultural">Cultural</option>
              <option value="time zone">Time zone</option>
              <option value="knowledge">Knowledge</option>
              <option value="no time">No time</option>
            </select>
          </div>

          <!-- ðŸ†• Position -->
          <div class="popup-field">
            <label>Position</label>
            <select name="position">
              <option value="">Selectâ€¦</option>
              <option>Founder/Co-Founder</option>
              <option>President</option>
              <option>Vice President</option>
              <option>CEO</option>
              <option>COO</option>
              <option>CFO/Finance Manager</option>
              <option>CTO</option>
              <option>General Manager</option>
              <option>Hiring Manager</option>
              <option>Talent Acquisition/Recruiter</option>
              <option>Student/Freelancer</option>
              <option>Unemployed</option>
              <option>Other</option>
              <option>Unknown</option>
            </select>
          </div>

          <!-- ðŸ†• Type -->
          <div class="popup-field">
            <label>Type</label>
            <select name="type">
              <option value="NA">NA</option>
              <option value="Firm">Firm</option>
              <option value="SMB">SMB</option>
              <option value="Startup">Startup</option>
            </select>
          </div>

          <!-- About -->
          <div class="popup-field full">
            <label>About</label>
            <textarea name="about" placeholder="Write a description..."></textarea>
          </div>

          <button type="submit" class="create-btn">Create</button>
        </form>
    </div>
  </div>

  <!-- ====================== SORT TOAST ====================== -->
  <div
    id="crmSortToast"
    class="sort-toast"
    role="status"
    aria-live="polite"
    style="display:none"
  >
    <div class="sort-toast__content">
      <div class="sort-toast__header">
        <span class="sort-toast__dot"></span>
        <span>Prepping the cutest view â€” sorting the table by <b>Status</b>â€¦</span>
      </div>

      <div
        class="sort-toast__progress"
        role="progressbar"
        aria-valuemin="0"
        aria-valuemax="100"
        aria-valuenow="0"
      >
        <div class="sort-toast__bar" style="width:0%"></div>
      </div>

      <div class="sort-toast__meta">
        <span id="sortToastPercent">0%</span>
      </div>
    </div>
  </div>
  <!-- BotÃ³n flotante de Log out -->
 <button type="button" class="logout-fab" id="logoutFab">
    <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
    <span>Log out</span>
  </button>
  <!-- ====================== SCRIPTS ====================== -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script src="./assets/js/avatar-map.js"></script>
  <script src="./assets/js/crm.js"></script>
  <script src="./assets/js/sidebar.js" defer></script>
</body>
</html>
